# Package : Gestion du Lave-Vaisselle
# Ce fichier regroupe toute la configuration (Helpers, Sensors, Automation) pour le lave-vaisselle.
# Pour l'activer, assurez-vous d'avoir ajout√© ce dossier √† votre configuration "packages".

# 1. HELPERS (Entr√©es)
# --------------------
input_number:
  # [HELPER] Co√ªt du kWh
  # Utilis√© pour calculer le co√ªt de chaque cycle.
  # Valeur par d√©faut : 0. √Ä configurer selon votre abonnement (ex: 0.2516).
  cout_du_kwh:
    name: "Co√ªt du kWh"
    min: 0
    max: 10
    step: 0.0001
    unit_of_measurement: "‚Ç¨/kWh"
    icon: mdi:currency-eur
    mode: box

input_select:
  # [HELPER] √âtat de la Machine
  # Stocke l'√©tat actuel (√âteint / En marche / Termin√©).
  # Essentiel pour g√©rer les red√©marrages de Home Assistant sans perdre le fil du cycle.
  etat_lave_vaisselle:
    name: "Lave Vaisselle - √âtat"
    options:
      - √âteint
      - En marche
      - Termin√©
    icon: mdi:dishwasher

input_datetime:
  # [HELPER] Horodatage
  # Deux entit√©s pour stocker l'heure de d√©but et de fin.
  # Permet de calculer la dur√©e pr√©cise du cycle, m√™me apr√®s un red√©marrage.
  debut_lave_vaisselle:
    name: "Lave Vaisselle - D√©but"
    has_date: true
    has_time: true
  fin_lave_vaisselle:
    name: "Lave Vaisselle - Fin"
    has_date: true
    has_time: true

# 2. UTILITY METER (Compteur Cycle)
# ---------------------------------
# Note: Si vous l'avez d√©j√† cr√©√© via l'UI, vous pouvez commenter ce bloc.
utility_meter:
  # [HELPER] Compteur de Cycle
  # Isole la consommation du cycle courant.
  # Il est remis √† z√©ro automatiquement au d√©but de chaque nouveau cycle (via l'automatisation).
  compteur_prislavvais_cycle:
    # [A_CHANGER] Remplacez 'sensor.prislavvais_energy' par votre capteur de consommation totale (kWh)
    source: sensor.prislavvais_energy
    name: "Compteur PrisLavVais Cycle"
    # cycle: never # Pas de cycle automatique (reset manuel via automation)

# 3. TEMPLATE SENSORS
# -------------------
template:
  - binary_sensor:
      # [SENSOR] D√©tection de fonctionnement
      # Ce capteur passe √† ON quand la puissance d√©passe le seuil d√©fini (machine en cours de lavage).
      - name: "Lave Vaisselle En Marche"
        unique_id: lave_vaisselle_en_marche
        device_class: running
        delay_on:
          minutes: 1
        delay_off:
          minutes: 3
        state: >
          # [A_CHANGER] Remplacez 'sensor.prislavvais_power' par votre capteur de puissance (W)
          # Ajustez le seuil (ici > 5W) selon la veille de votre appareil
          {{ states('sensor.prislavvais_power')|float(0) > 5 }}
        icon: mdi:dishwasher

  - sensor:
      # [SENSOR] √âtat Composite
      # Combine la d√©tection de puissance (Lavage) et la m√©morisation de fin de cycle (Termin√©) via l'input_select.
      - name: "Lave Vaisselle √âtat"
        unique_id: lave_vaisselle_etat
        icon: mdi:state-machine
        state: >
          {% if is_state('binary_sensor.lave_vaisselle_en_marche', 'on') %}
            Lavage
          {% elif is_state('input_select.etat_lave_vaisselle', 'Termin√©') %}
            Termin√©
          {% else %}
            √âteint
          {% endif %}

      # [SENSOR] Calcul de la Dur√©e
      # Affiche le temps √©coul√© depuis le d√©but (si en cours) ou la dur√©e totale du dernier cycle (si termin√©).
      - name: "Lave Vaisselle Dur√©e Cycle"
        unique_id: lave_vaisselle_duree_cycle
        icon: mdi:timer
        state: >
          {% set debut = states('input_datetime.debut_lave_vaisselle') %}
          {% set fin = states('input_datetime.fin_lave_vaisselle') %}
          {% set etat = states('sensor.lave_vaisselle_etat') %}
          
          {% if debut != 'unknown' %}
            {% set debut_ts = as_timestamp(debut) %}
            {% set now_ts = as_timestamp(now()) %}
            
            {% if etat == 'Lavage' %}
              {{ ((now_ts - debut_ts) / 60) | round(0) }} min
            {% elif etat == 'Termin√©' and fin != 'unknown' %}
               {% set fin_ts = as_timestamp(fin) %}
               {{ ((fin_ts - debut_ts) / 60) | round(0) }} min
            {% else %}
              0 min
            {% endif %}
          {% else %}
            Inconnu
          {% endif %}
        attributes:
          debut: "{{ states('input_datetime.debut_lave_vaisselle') }}"
          fin: "{{ states('input_datetime.fin_lave_vaisselle') }}"

      # [SENSOR] Estimation du Co√ªt
      # Multiplie la consommation du cycle actuel (kWh) par le prix unitaire (‚Ç¨/kWh).
      - name: "Lave Vaisselle Co√ªt Cycle"
        unique_id: lave_vaisselle_cout_cycle
        icon: mdi:cash
        unit_of_measurement: "‚Ç¨"
        state: >
          {% set energie = states('sensor.compteur_prislavvais_cycle') | float(0) %}
          # [A_CHANGER] Remplacez 'input_number.cout_du_kwh' par votre entit√© de co√ªt unitaire
          {% set prix = states('input_number.cout_du_kwh') | float(0) %}
          {{ (energie * prix) | round(2) }}

# 4. AUTOMATION
# -------------
automation:
  - alias: üçΩÔ∏è Lave-Vaisselle - Gestion Cycle & Notifications (Package)
    description: "Gestion compl√®te du cycle et des notifications (Version Package)"
    mode: restart
    triggers:
      # 1. D√âMARRAGE : Quand la puissance d√©passe le seuil (via le binary_sensor)
      - trigger: state
        entity_id: binary_sensor.lave_vaisselle_en_marche
        from: "off"
        to: "on"
        id: "demarrage"
      # 2. FIN : Quand la puissance repasse sous le seuil
      - trigger: state
        entity_id: binary_sensor.lave_vaisselle_en_marche
        from: "on"
        to: "off"
        id: "fin"
      # 3. RED√âMARRAGE HA : Pour relancer la boucle de notification si le cycle √©tait "Termin√©"
      - trigger: homeassistant
        event: start
        id: "redemarrage"
    conditions: []
    actions:
      - choose:
          # CAS A : D√âMARRAGE
          # On initialise tout : Reset compteur kWh, √âtat=En marche, Heure de d√©but.
          - conditions:
              - condition: trigger
                id: "demarrage"
            sequence:
              - action: utility_meter.reset
                target:
                  entity_id: sensor.compteur_prislavvais_cycle
              - action: input_select.select_option
                target:
                  entity_id: input_select.etat_lave_vaisselle
                data:
                  option: "En marche"
              - action: input_datetime.set_datetime
                target:
                  entity_id: input_datetime.debut_lave_vaisselle
                data:
                  datetime: "{{ now() }}"
              - action: script.notification_alexa
                data:
                  message: "Le lave-vaisselle est lanc√©."

          # CAS B : FIN DU CYCLE
          # On valide la fin : √âtat=Termin√©, Heure de fin.
          - conditions:
              - condition: trigger
                id: "fin"
            sequence:
              - action: input_select.select_option
                target:
                  entity_id: input_select.etat_lave_vaisselle
                data:
                  option: "Termin√©"
              - action: input_datetime.set_datetime
                target:
                  entity_id: input_datetime.fin_lave_vaisselle
                data:
                  datetime: "{{ now() }}"

          # CAS C : RED√âMARRAGE HA
          # S√©curit√© : On attend que les entit√©s soient pr√™tes pour √©viter les erreurs de lecture.
          - conditions:
              - condition: trigger
                id: "redemarrage"
            sequence:
              # On attend que les entit√©s soient disponibles
              - wait_template: >-
                  {{ has_value('input_select.etat_lave_vaisselle') and 
                     has_value('switch.prislavvais') }} # [A_CHANGER] Remplacez par votre prise connect√©e
                timeout: "00:05:00"
                continue_on_timeout: false

      # BOUCLE DE NOTIFICATION (COMMUNE)
      - if:
          - condition: state
            entity_id: input_select.etat_lave_vaisselle
            state: "Termin√©"
          - condition: state
            # [A_CHANGER] Remplacez par votre prise connect√©e
            entity_id: switch.prislavvais
            state: "on"
        then:
          - repeat:
              sequence:
                - action: persistent_notification.create
                  data:
                    message: |
                      Cycle termin√©.
                      Dur√©e : {{ states('sensor.lave_vaisselle_duree_cycle') }}
                      Conso : {{ states('sensor.compteur_prislavvais_cycle') }} kWh
                      Co√ªt : {{ states('sensor.lave_vaisselle_cout_cycle') }} ‚Ç¨
                    title: "üçΩÔ∏è Lave-Vaisselle Termin√©"
                    notification_id: "lave_vaisselle_fin"

                - delay:
                    hours: 0
                    minutes: 5
                    seconds: 0
                    milliseconds: 0

              while:
                - condition: state
                  # [A_CHANGER] La boucle s'arr√™te si la prise est √©teinte
                  entity_id: switch.prislavvais
                  state: "on"
