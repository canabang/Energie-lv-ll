alias: üß∫ Lave-Linge - Gestion Cycle & Notifications (V4 - No Poll)
description: "Version 4 : Boucle Repeat r√©siliente (se relance au red√©marrage si n√©cessaire)"
mode: restart
triggers:
  # 1. D√âMARRAGE
  - trigger: state
    entity_id: binary_sensor.lave_linge_en_marche
    from: "off"
    to: "on"
    id: "demarrage"

  # 2. FIN (D√©clenche la boucle)
  - trigger: state
    entity_id: binary_sensor.lave_linge_en_marche
    from: "on"
    to: "off"
    id: "fin"

  # 3. RED√âMARRAGE HA (Relance la boucle si besoin)
  - trigger: homeassistant
    event: start
    id: "redemarrage"

conditions: []

actions:
  # ---------------------------------------------------------
  # 1. INITIALISATION SELON LE D√âCLENCHEUR
  # ---------------------------------------------------------
  - choose:
      # CAS A : D√âMARRAGE
      - conditions:
          - condition: trigger
            id: "demarrage"
        sequence:
          - action: utility_meter.reset
            target:
              entity_id: sensor.compteur_prismal_cycle
          - action: input_select.select_option
            target:
              entity_id: input_select.etat_lave_linge
            data:
              option: "En marche"
          - action: input_datetime.set_datetime
            target:
              entity_id: input_datetime.debut_machine
            data:
              datetime: "{{ now() }}"
          - action: script.notification_alexa
            data:
              message: "La machine √† laver est lanc√©e."

      # CAS B : FIN DU CYCLE
      - conditions:
          - condition: trigger
            id: "fin"
        sequence:
          - action: input_select.select_option
            target:
              entity_id: input_select.etat_lave_linge
            data:
              option: "Termin√©"
          - action: input_datetime.set_datetime
            target:
              entity_id: input_datetime.fin_machine
            data:
              datetime: "{{ now() }}"

      # CAS C : RED√âMARRAGE HA
      - conditions:
          - condition: trigger
            id: "redemarrage"
        sequence:
          # On attend que les entit√©s soient disponibles (plus d'inconnu/indisponible)
          - wait_template: >-
              {{ has_value('input_select.etat_lave_linge') and 
                 has_value('switch.prismal') }}
            timeout: "00:05:00"
            continue_on_timeout: false

  # ---------------------------------------------------------
  # 2. BOUCLE DE NOTIFICATION (COMMUNE)
  # ---------------------------------------------------------
  - if:
      - condition: state
        entity_id: input_select.etat_lave_linge
        state: "Termin√©"
      - condition: state
        entity_id: switch.prismal
        state: "on"
    then:
      - repeat:
          sequence:
            # A. G√©n√©ration Message (Fra√Æcheur des donn√©es)
            - action: script.k_2so_generateur_de_message
              data:
                mission: machine √† laver finie
                consigne: |
                  Annonce la fin du cycle.
                  Consommation : {{ states('sensor.compteur_prismal_cycle') }} kWh.
                  Dur√©e : {{ states('sensor.lave_linge_duree_cycle') }}.
                  Co√ªt : {{ states('sensor.lave_linge_cout_cycle') }} ‚Ç¨.
                  Ton : Serviable mais pressant.
              response_variable: generated_message
            
            # B. Notifications
            - action: script.notification_alexa
              data:
                message: "{{ generated_message.data }}"
            
            - action: script.awtrix_dynamique_customapp_and_notify
              data:
                icone: mal
                rainbow: "true"
                scrollspeed: "50"
                color: "#2e8b57"
                duree: "25"
                message: "Lave-Linge Fin | {{ generated_message.data }}"
            
            - action: script.notification_discord
              metadata: {}
              data:
                nom: √† remplacer
                description: >-
                  {{ generated_message.data }}

                  Consommation : {{ states('sensor.compteur_prismal_cycle') }} kWh. 
                  Dur√©e : {{ states('sensor.lave_linge_duree_cycle') }}.
                  Co√ªt : {{ states('sensor.lave_linge_cout_cycle') }} ‚Ç¨.
                image_url: https://i.ibb.co/pRvFCBy/home-assistant.png
            - delay:
                hours: 0
                minutes: 5
                seconds: 0
                milliseconds: 0

            # C. Wait 5 minutes
            - delay:
                hours: 0
                minutes: 5
                seconds: 0
                milliseconds: 0

          # CONDITION DE SORTIE : Si la prise est √©teinte, on arr√™te.
          while:
            - condition: state
              entity_id: switch.prismal
              state: "on"
