alias: üß∫ Lave-Linge - Gestion Cycle & Notifications (Simple)
description: "Gestion du cycle et notification persistante (Version Simple)"
mode: restart
triggers:
  - trigger: state
    entity_id: binary_sensor.lave_linge_en_marche
    from: "off"
    to: "on"
    id: demarrage
  # 2. FIN : Quand la puissance repasse sous le seuil
  - trigger: state
    entity_id: binary_sensor.lave_linge_en_marche
    from: "on"
    to: "off"
    id: fin
  # 3. RED√âMARRAGE HA : Pour relancer la boucle de notification si le cycle √©tait "Termin√©"
  - trigger: homeassistant
    event: start
    id: redemarrage
conditions: []
actions:
  - choose:
      # CAS A : D√âMARRAGE
      # On initialise tout : Reset compteur kWh, √âtat=En marche, Heure de d√©but.
      - conditions:
          - condition: trigger
            id: demarrage
        sequence:
          - action: utility_meter.reset
            target:
              entity_id: sensor.compteur_lave_linge_cycle
          - action: input_select.select_option
            target:
              entity_id: input_select.etat_lave_linge
            data:
              option: En marche
          - action: input_datetime.set_datetime
            target:
              entity_id: input_datetime.debut_machine
            data:
              datetime: "{{ now() }}"

      # CAS B : FIN DU CYCLE
      # On valide la fin : √âtat=Termin√©, Heure de fin.
      - conditions:
          - condition: trigger
            id: fin
        sequence:
          - action: input_select.select_option
            target:
              entity_id: input_select.etat_lave_linge
            data:
              option: Termin√©
          - action: input_datetime.set_datetime
            target:
              entity_id: input_datetime.fin_machine
            data:
              datetime: "{{ now() }}"

      # CAS C : RED√âMARRAGE HA
      # S√©curit√© : On attend que les entit√©s soient pr√™tes pour √©viter les erreurs de lecture.
      - conditions:
          - condition: trigger
            id: redemarrage
        sequence:
           # On attend que les entit√©s soient disponibles
          - wait_template: |-
              {{ has_value('input_select.etat_lave_linge') and 
                 has_value('switch.prismal') }} # [A_CHANGER] Remplacez par votre prise connect√©e
            timeout: "00:05:00"
            continue_on_timeout: false

  # BOUCLE DE NOTIFICATION (COMMUNE)
  - if:
      - condition: state
        entity_id: input_select.etat_lave_linge
        state: Termin√©
      - condition: state
        # [A_CHANGER] Remplacez par votre prise connect√©e
        entity_id: switch.prismal
        state: "on"
    then:
      - repeat:
          sequence:
            - action: persistent_notification.create
              data:
                message: |
                  Cycle termin√©.
                  ‚è±Ô∏è Dur√©e : {{ states('sensor.lave_linge_duree_cycle') }}
                  ‚ö° Conso : {{ states('sensor.compteur_lave_linge_cycle') }} kWh
                  üí∂ Co√ªt : {{ states('sensor.lave_linge_cout_cycle') }} ‚Ç¨
                title: üß∫ Lave-Linge Termin√©

            - delay:
                hours: 0
                minutes: 5
                seconds: 0
                milliseconds: 0

          while:
            - condition: state
              # [A_CHANGER] La boucle s'arr√™te si la prise est √©teinte
              entity_id: switch.prismal
              state: "on"
